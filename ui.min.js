var threads=[],thread_watch=[],jwk_wants_array=false,has_crypto=window.crypto&&crypto.subtle,vowels="aeiouy",consonants="bcdfghklmnprstvzx",algorithms={RSA:{RS1:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-1"}},RS256:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},RS384:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-512"}},RS512:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-512"}}}};$(document).ready(function(){var c,a=$('<div id="thread_button" class="reply_button">New thread</div>'),b=$('<div id="thread_list"></div>');a.click(function(){reply_form(-1)});$("body").append(a);if(has_crypto){crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-1"}},true,["sign","verify"]).then(function(d){return crypto.subtle.exportKey("jwk",d.publicKey)},function(d){console.error.bind(console,"Unable to generate key:\n")(d);has_crypto=false}).then(function(d){if(d instanceof ArrayBuffer){jwk_wants_array=true}},console.error.bind(console,"Unable to export public key:\n"))}$("body").append(b);if(window.EventSource){c=new EventSource("watch.pl");c.addEventListener("message",function(d){update_threads(JSON.parse(d.data))})}else{$.getJSON("threads",{},update_threads)}});function update_threads(f){var e=threads,a,b,c=f.length-e.length,d=$("#thread_list");threads=f;for(b=0;b<c;++b){a=$("<div>",{"class":"thread_title",id:threads[b].id});d.prepend(a);a.append(threads[b].title)}$(".thread_title").click(show_thread)}function show_thread(){var a=this.id;$(this).unbind("click",show_thread);$(this).bind("click",hide_thread);if(window.EventSource){thread_watch[a]=new EventSource("watch.pl?thread="+a);thread_watch[a].addEventListener("message",function(b){add_comments(a,JSON.parse(b.data))})}else{$.getJSON("thread/"+a,{},function(b){add_comments(a,b)})}}function hide_thread(){var a=this.id;$(this).children().remove();thread_watch[a].close();$(this).unbind("click",hide_thread);$(this).bind("click",show_thread)}function add_comments(f,b){var d=$("#"+f),c,a,e;if(d.children().length){c=d.children().first();c.children().last().remove()}else{c=$('<div class="thread"></div>');$("#"+f).append(c)}c.bind("click",function(){return false});for(a=c.children().length;a<b.length;++a){e=$("<div>",{"class":"comment",id:f+"_"+(a+1)});e.append($('<div class="post_number">'+(a+1)+"</div>"));e.append($("<div>").text(b[a].comment));if(has_crypto&&b[a].key){verify_signature(f,a,b[a])}c.append(e)}c.append($('<div class="reply_button">Reply</div>').click(function(){reply_form(f)}))}function verify_signature(g,f,d){var e=new Uint8Array(256),c,b,a=algorithms[d.key.kty][d.key.alg];for(c=0;c<256;++c){e[c]=d.signature[c]}crypto.subtle.importKey("jwk",jwk_object_to_import(d.key),a,true,["verify"]).then(function(h){b=h;return crypto.subtle.verify(a,b,e,string_to_array(d.comment,Uint16Array))},console.error.bind(console,"Unable to import public key:\n")).then(function(h){if(h){$("#"+g+"_"+(f+1)).addClass("valid");return crypto.subtle.exportKey("jwk",b)}else{$("#"+g+"_"+(f+1)).addClass("invalid")}},console.error.bind(console,"Unable to verify signature:\n")).then(function(h){return crypto.subtle.digest({name:"SHA-256"},jwk_export_to_array(h))},console.error.bind(console,"Unable to export key:\n")).then(function(h){if(h){$("#"+g+"_"+(f+1)).attr("title",bubble_babble(new Uint8Array(h)))}},console.error.bind(console,"Unable to compute hash:\n"))}function reply_form(g){var b=$('<div id="reply_form">'),d=$("<form></form>"),c=$('<div id="close">Ã—</div>'),e,f,a;d.submit(function(){return false});$("body").append(b);b.append(d);c.click(function(){$("#reply_form").remove()});d.append(c);d.append($("<input>",{type:"hidden",id:"thread",value:g}));if(g<0){d.append($('<input id="title" required placeholder="Title">'))}d.append($('<textarea id="comment" rows="10" required placeholder="Comment"></textarea>'));if(has_crypto){e=$('<textarea id="key" rows="1" placeholder="Key (optional)"></textarea>');e.change(update_preview);e.keyup(update_preview);d.append(e);d.append($('<input type="text" disabled id="hash_preview">'));f=$('<input type="button" value="Generate Key">');f.click(function(){generate_key(algorithms.RSA.RS256)});d.append(f)}a=$('<input type="submit" id="submit_button">');a.click(submit_form);d.append(a)}function generate_key(a){if(a.name.startsWith("RSA")){if(!a.publicExponent){a.publicExponent=new Uint8Array([1,0,1])}if(!a.modulusLength){a.modulusLength=2048}}crypto.subtle.generateKey(a,true,["sign","verify"]).then(function(b){return crypto.subtle.exportKey("jwk",b.privateKey)},console.error.bind(console,"Unable to generate key:\n")).then(function(b){$("#key").val(jwk_export_to_string(b));update_preview()})}function update_preview(){var a=JSON.parse($("#key").val());delete a.d;delete a.dp;delete a.dq;delete a.p;delete a.q;delete a.qi;a.key_ops=["verify"];crypto.subtle.importKey("jwk",jwk_object_to_import(a),algorithms[a.kty][a.alg],true,["verify"]).then(function(b){a=b;return crypto.subtle.exportKey("jwk",a)},console.error.bind(console,"Unable to import key:\n")).then(function(b){if(b){return crypto.subtle.digest({name:"SHA-256"},jwk_export_to_array(b))}},console.error.bind(console,"Unable to export key:\n")).then(function(b){$("#hash_preview").val(bubble_babble(new Uint8Array(b)))},console.error.bind(console,"Unable to compute hash:\n"))}function submit_form(){var d=$("#title").val(),b=$("#thread").val(),e=$("#comment").val(),c=$("#key").val(),a;$("#submit_button").attr("disabled",true);if(c){a=JSON.parse(c),algorithm=algorithms[a.kty][a.alg];crypto.subtle.importKey("jwk",jwk_object_to_import(a),algorithm,true,["sign"]).then(function(f){if(f){delete a.d;delete a.dp;delete a.dq;delete a.p;delete a.q;delete a.qi;a.key_ops=["verify"];return crypto.subtle.sign(algorithm,f,string_to_array(e,Uint16Array))}},function(f){var g="Unable to import private key:\n";console.error.bind(console,g)(f);alert(g+f);$("#submit_button").attr("disabled",false)}).then(function(g){if(g){var j=new Uint8Array(g),f=new Array(256),h;for(h=0;h<256;++h){f[h]=j[h]}return f}},function(f){var g="Unable to sign post:\n";console.error.bind(console,g)(f);alert(g+f);$("#submit_button").attr("disabled",false)}).then(function(f){if(f){$.post("post.pl",{title:d,thread:b,comment:e,key:JSON.stringify(a),signature:JSON.stringify(f)},function(){if(window.EventSource){$("#reply_form").remove()}else{location.reload()}}).fail(function(){alert("Post failed. Please check your input and try again.");$("#submit_botton").attr("disabled",false)})}})}else{$.post("post.pl",{title:d,thread:b,comment:e},function(){if(window.EventSource){$("#reply_form").remove()}else{location.reload()}}).fail(function(){alert("Post failed. Please check your input and try again.");$("#submit_button").attr("disabled",false)})}}function string_to_array(a,c){var d=new c(a.length),b;for(b=0;b<a.length;++b){d[b]=a.charCodeAt(b)}return d}function array_to_string(c){var a="",b;for(b=0;b<c.length;++b){a+=String.fromCharCode(c[b])}return a}function jwk_export_to_string(a){if(a instanceof ArrayBuffer){return array_to_string(new Uint8Array(a))}return JSON.stringify(a)}function jwk_export_to_array(a){if(a instanceof ArrayBuffer){return a}return string_to_array(JSON.stringify(a),Uint8Array)}function jwk_object_to_import(a){if(jwk_wants_array){return string_to_array(JSON.stringify(a),Uint8Array)}return a}function op(b,f){var a=(((b>>6)&3)+f)%6,e=(b>>2)&15,d=((b&3)+Math.floor(f/6))%6;return vowels.charAt(a)+consonants.charAt(e)+vowels.charAt(d)}function ep(d){var a=d%6,b=Math.floor(d/6);return vowels.charAt(a)+"x"+vowels.charAt(b)}function nc(f,e,d){return((f*5)+(e*7)+d)%36}function bubble_babble(d){var f="x",g=1,b=d.length,e;for(e=0;e+1<b;e+=2){f+=op(d[e],g);f+=consonants.charAt((d[e+1]>>4)&15)+"-"+consonants.charAt(d[e+1]);g=nc(g,d[e],d[e+1])}f+=(e<b?op(d[e],g):ep(g))+"x";return f};